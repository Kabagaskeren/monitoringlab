<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="author" content="templatemo">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap"
        rel="stylesheet">
    <title>Monitoring Website - BBMKG IV Makassar</title>
    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="assets/images/logo.png" type="image/icon type">

    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/templatemo-liberty-market.css">
    <link rel="stylesheet" href="assets/css/owl.css">
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css" />

    <style>
    .sticky-footer-table tfoot {
        position: sticky;
        bottom: 0;
        background-color: #f2f2f2;
        z-index: 1;
    }
    </style>
</head>

<body>
    <!-- ***** Preloader Start ***** -->
    <div id="js-preloader" class="js-preloader">
        <div class="preloader-inner">
            <span class="dot"></span>
            <div class="dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
    <!-- ***** Preloader End ***** -->

    <!-- ***** Header Area Start ***** -->
    <header class="header-area header-sticky">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <nav class="main-nav">
                        <!-- ***** Logo Start ***** -->
                        <a href="index.php" class="logo">
                            <img src="assets/images/logo.png" alt="">
                            <span class="logo-text">BBMKG IV - MAKASSAR</span>
                        </a>
                        <!-- ***** Logo End ***** -->

                        <!-- ***** Menu Start ***** -->
                        <ul class="nav">
                            <li><a href="#" class="active">Home</a></li>
                        </ul>
                        <a class='menu-trigger'>
                            <span>Menu</span>
                        </a>
                        <!-- ***** Menu End ***** -->
                    </nav>
                </div>
            </div>
        </div>
    </header>
    <!-- ***** Header Area End ***** -->

    <!-- ***** Main Banner Area Start ***** -->
    <div class="main-banner">
        <div class="container">
            <div class="row">
                <div class="col-lg align-self-center">
                    <div class="header-text">
                        <h6>Selamat Datang</h6>
                        <h2>Monitoring<br />Ruang Server</h2>
                        <p>Balai Besar Meteorologi Klimatologi Dan Geofisika Wilayah IV - Makassar</p>
                        <div class="buttons">
                            <div class="col">
                                <div class="main-button">
                                    <a href="#" id="download-csv">Download .csv Data</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col align-self-center" style="border:0px solid white;margin-top:50px;">
                    <div class="row">
                        <div class="grid-item">
                            <h6>Suhu</h6>
                            <h1 id="suhu">Loading... <span style="font-size:25px;">°C</span></h1>
                            <p>Rata-Rata Suhu:</p>
                            <h4 id="average-suhu">Loading... <span style="font-size:25px;">°C</span></h4>
                        </div>

                        <div class="grid-item">
                            <h6>Kelembaban</h6>
                            <h1 id="kelembaban">Loading... <span style="font-size:25px;">%rh</span></h1>
                            <p>Rata-Rata Kelembaban:</p>
                            <h4 id="average-kelembaban">Loading... <span style="font-size:25px;">%rh</span></h4>
                        </div>
                    </div>

                    <div class="alert-section" id="alert-section">
                        <h3>Alert!</h3>
                    </div>
                </div>
            </div>
        </div>
        <!-- ***** Data Table Start ***** -->
        <div class="row" style="margin-top:100px">
            <div class="col-lg-12">
                <h3>Data Tabel</h3>
                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th scope="col">Timestamp</th>
                                <th scope="col">Suhu (°C)</th>
                                <th scope="col">Kelembaban (%rh)</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="iframe">
                    <h3 style="margin-bottom: 50px;">Data Grafik</h3>
                    <iframe width="450" height="260"
                        style="border: 1px solid #cccccc;border-radius:20px; margin-right:100px"
                        src="https://thingspeak.com/channels/2598293/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&title=Suhu&type=line"></iframe>
                    <iframe width="450" height="260" style="border: 1px solid #cccccc;border-radius:20px;"
                        src="https://thingspeak.com/channels/2598293/charts/2?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&title=Kelembaban&type=line"></iframe>
                </div>
            </div>
        </div>
        <!-- ***** Data Table End ***** -->
    </div>
    <!-- ***** Main Banner Area End ***** -->



    <div class="create-nft">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    <div class="section-heading">
                        <div class="line-dec"></div>
                        <h2><a href="https://bbmkg4.com/" style="color:white;">Balai Besar Meteorologi Klimatologi Dan
                                Geofisika Wilayah IV</a></h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container" style="height: 30px;">
            <div class="row">
                <div class="col-lg-12">
                    <p>Copyright © 2024 <a href="https://www.instagram.com/zuhrifalah/">Nur Muhamad Zuhri Falah</a> .
                        All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/isotope.min.js"></script>
    <script src="assets/js/owl-carousel.js"></script>
    <script src="assets/js/tabs.js"></script>
    <script src="assets/js/popup.js"></script>
    <script src="assets/js/custom.js"></script>

    <script>
    function fetchData() {
        var apiURL = 'https://api.thingspeak.com/channels/2598293/feeds.json?api_key=PK3HOBKZL1TIAQRP&results=50';

        fetch(apiURL)
            .then(response => response.json())
            .then(data => {
                console.log(data); // Debugging output
                var feeds = data.feeds;
                if (feeds.length > 0) {
                    // Urutkan feeds berdasarkan timestamp, terbaru di atas
                    feeds.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    // Update current values display
                    var latestFeed = feeds[0];
                    var suhu = parseFloat(latestFeed.field1) || 0;
                    var kelembaban = parseFloat(latestFeed.field2) || 0;
                    document.getElementById('suhu').innerHTML = suhu + ' <span style="font-size:25px;">°C</span>';
                    document.getElementById('kelembaban').innerHTML = kelembaban +
                        ' <span style="font-size:25px;">%rh</span>';

                    // Update table with all data and calculate averages
                    var tableBody = document.getElementById('data-table-body');
                    var averageSuhu = 0;
                    var averageKelembaban = 0;

                    tableBody.innerHTML = '';
                    feeds.forEach(feed => {
                        var row = document.createElement('tr');
                        var timestampCell = document.createElement('td');
                        var suhuCell = document.createElement('td');
                        var kelembabanCell = document.createElement('td');

                        timestampCell.textContent = feed.created_at;
                        suhuCell.textContent = parseFloat(feed.field1) || 0;
                        kelembabanCell.textContent = parseFloat(feed.field2) || 0;

                        row.appendChild(timestampCell);
                        row.appendChild(suhuCell);
                        row.appendChild(kelembabanCell);

                        tableBody.appendChild(row);

                        // Sum for averages
                        averageSuhu += parseFloat(feed.field1) || 0;
                        averageKelembaban += parseFloat(feed.field2) || 0;
                    });

                    // Calculate and display averages
                    averageSuhu = (averageSuhu / feeds.length).toFixed(2);
                    averageKelembaban = (averageKelembaban / feeds.length).toFixed(2);

                    document.getElementById('average-suhu').textContent = averageSuhu + ' °C';
                    document.getElementById('average-kelembaban').textContent = averageKelembaban + ' %rh';

                    // Menginisialisasi kondisi untuk normal
                    var suhuNormal = suhu >= 20 && suhu <= 23;
                    var kelembabanNormal = kelembaban >= 45 && kelembaban <= 60;

                    // Logika untuk alert
                    var alertSection = document.getElementById("alert-section");
                    var alertText = alertSection.querySelector("h3");

                    if (!suhuNormal && !kelembabanNormal) {
                        alertSection.style.display = "block";
                        alertSection.classList.remove("normal");
                        alertSection.classList.add("alert");
                        alertText.innerHTML = "Suhu & Kelembaban tidak normal!";
                    } else if (!suhuNormal) {
                        alertSection.style.display = "block";
                        alertSection.classList.remove("normal");
                        alertSection.classList.add("alert");
                        alertText.innerHTML = "Suhu tidak normal!";
                    } else if (!kelembabanNormal) {
                        alertSection.style.display = "block";
                        alertSection.classList.remove("normal");
                        alertSection.classList.add("alert");
                        alertText.innerHTML = "Kelembaban tidak normal!";
                    } else {
                        alertSection.style.display = "block";
                        alertSection.classList.remove("alert");
                        alertSection.classList.add("normal");
                        alertText.innerHTML = "Suhu dan kelembaban normal";
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    function downloadCSV() {
        var csvURL = 'https://api.thingspeak.com/channels/2598293/feeds.csv?api_key=PK3HOBKZL1TIAQRP';
        var link = document.createElement('a');
        link.href = csvURL;
        link.download = 'thingSpeakData.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    setInterval(fetchData, 15000);
    fetchData();

    document.getElementById('download-csv').addEventListener('click', function(event) {
        event.preventDefault();
        downloadCSV();
    });
    </script>
</body>

</html>
